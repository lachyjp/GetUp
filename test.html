<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GetUp - Test Suite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-pass { color: #28a745; }
        .test-fail { color: #dc3545; }
        .test-suite {
            margin-bottom: 30px;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #ddd;
            padding-left: 10px;
        }
        .test-pass .test-result { border-left-color: #28a745; }
        .test-fail .test-result { border-left-color: #dc3545; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #test-summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª GetUp Test Suite</h1>
    
    <div id="test-summary">
        <h3>Test Summary</h3>
        <div id="summary-content">Click "Run All Tests" to start testing...</div>
    </div>

    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="runUtilsTests()">Test Utils</button>
    <button onclick="runDataTests()">Test Data Processing</button>
    <button onclick="runApiTests()">Test API Functions</button>
    <button onclick="runUiTests()">Test UI Functions</button>

    <div id="test-results"></div>

    <!-- Load the modules -->
    <script src="utils.js"></script>
    <script src="data.js"></script>
    <script src="ui.js"></script>
    <script src="api.js"></script>
    <script src="main.js"></script>

    <!-- Test Framework -->
    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            tests: []
        };

        function assert(condition, message) {
            if (!condition) {
                throw new Error(message || 'Assertion failed');
            }
        }

        function runTest(testName, testFunction) {
            testResults.total++;
            try {
                testFunction();
                testResults.passed++;
                testResults.tests.push({ name: testName, status: 'PASS', error: null });
                return true;
            } catch (error) {
                testResults.failed++;
                testResults.tests.push({ name: testName, status: 'FAIL', error: error.message });
                return false;
            }
        }

        function displayResults() {
            const summary = document.getElementById('summary-content');
            const results = document.getElementById('test-results');
            
            summary.innerHTML = `
                <strong>Total Tests:</strong> ${testResults.total} | 
                <strong class="test-pass">Passed:</strong> ${testResults.passed} | 
                <strong class="test-fail">Failed:</strong> ${testResults.failed} | 
                <strong>Success Rate:</strong> ${testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0}%
            `;

            results.innerHTML = testResults.tests.map(test => `
                <div class="test-result ${test.status === 'PASS' ? 'test-pass' : 'test-fail'}">
                    <strong>${test.status}</strong> - ${test.name}
                    ${test.error ? `<br><small>Error: ${test.error}</small>` : ''}
                </div>
            `).join('');
        }

        // Test Utils Functions
        function runUtilsTests() {
            testResults = { total: 0, passed: 0, failed: 0, tests: [] };
            
            runTest('sanitizeInput removes dangerous characters', () => {
                const input = '<script>alert("xss")</script>';
                const result = sanitizeInput(input);
                assert(!result.includes('<') && !result.includes('>'), 'Should remove < and > characters');
            });

            runTest('escapeHtml escapes HTML entities', () => {
                const input = '<div>Test & "quotes"</div>';
                const result = escapeHtml(input);
                assert(result.includes('&lt;') && result.includes('&amp;'), 'Should escape HTML entities');
            });

            runTest('validateApiKey accepts valid Up API key format', () => {
                const validKey = 'up:yeah:ABC123DEF456';
                assert(validateApiKey(validKey), 'Should accept valid Up API key format');
            });

            runTest('validateApiKey rejects invalid formats', () => {
                const invalidKey = 'invalid-key';
                assert(!validateApiKey(invalidKey), 'Should reject invalid API key format');
            });

            runTest('removeDuplicates removes duplicate values', () => {
                const array = [1, 2, 2, 3, 3, 3];
                const result = removeDuplicates(array);
                assert(result.length === 3, 'Should remove duplicates');
                assert(result.includes(1) && result.includes(2) && result.includes(3), 'Should contain unique values');
            });

            runTest('formatDate splits ISO date correctly', () => {
                const isoDate = '2025-10-08T19:10:00+10:00';
                const result = formatDate(isoDate);
                assert(result.length === 2, 'Should return array with 2 elements');
                assert(result[0] === '2025-10-08', 'Should extract date part');
                assert(result[1].includes('19:10:00'), 'Should extract time part');
            });

            runTest('formatTime converts to 12-hour format', () => {
                const time = '19:10:00+10:00';
                const result = formatTime(time);
                assert(result.includes('pm'), 'Should convert to 12-hour format');
                assert(result.includes('7:10'), 'Should show correct time');
            });

            displayResults();
        }

        // Test Data Processing Functions
        function runDataTests() {
            testResults = { total: 0, passed: 0, failed: 0, tests: [] };
            
            runTest('Transaction class creates valid objects', () => {
                const txn = new Transaction('Test', '+', 100, 'SETTLED', '2025-10-08', '7:10pm', 'Merchant', 'Message', 'false');
                assert(txn.desc === 'Test', 'Should set description');
                assert(txn.val === 100, 'Should set value');
                assert(txn.type === '+', 'Should set type');
            });

            runTest('Account class creates valid objects', () => {
                const acc = new Account('Spending', 1000, 'SAVER', 'INDIVIDUAL');
                assert(acc.name === 'Spending', 'Should set name');
                assert(acc.balance === 1000, 'Should set balance');
                assert(acc.type === 'SAVER', 'Should set type');
            });

            runTest('calculateSpendingStats handles empty array', () => {
                const result = calculateSpendingStats([]);
                assert(result.totalSpent === '0.00', 'Should handle empty array');
                assert(result.daysBetween === 0, 'Should return 0 days for empty array');
            });

            runTest('calculateSpendingStats calculates correctly', () => {
                const transactions = [
                    new Transaction('Purchase', '', 50, 'SETTLED', '2025-10-01', '10:00am', 'Store', 'Message', 'false'),
                    new Transaction('Purchase', '', 30, 'SETTLED', '2025-10-02', '11:00am', 'Store2', 'Message', 'false'),
                    new Transaction('Transfer', '', 100, 'SETTLED', '2025-10-03', '12:00pm', 'Bank', 'Message', 'false')
                ];
                const result = calculateSpendingStats(transactions);
                assert(parseFloat(result.totalSpent) === 80, 'Should calculate spending excluding transfers');
                assert(result.daysBetween >= 0, 'Should calculate days between');
            });

            runTest('countUniqueMerchants counts correctly', () => {
                const transactions = [
                    new Transaction('Purchase', '', 50, 'SETTLED', '2025-10-01', '10:00am', 'Store1', 'Message', 'false'),
                    new Transaction('Purchase', '', 30, 'SETTLED', '2025-10-02', '11:00am', 'Store2', 'Message', 'false'),
                    new Transaction('Transfer from Spending', '', 100, 'SETTLED', '2025-10-03', '12:00pm', 'Bank', 'Message', 'false')
                ];
                const result = countUniqueMerchants(transactions);
                assert(result === 2, 'Should count unique merchants excluding transfers');
            });

            displayResults();
        }

        // Test API Functions
        function runApiTests() {
            testResults = { total: 0, passed: 0, failed: 0, tests: [] };
            
            runTest('API_CONFIG has correct structure', () => {
                assert(API_CONFIG.accountsUrl, 'Should have accounts URL');
                assert(API_CONFIG.transactionsUrl, 'Should have transactions URL');
                assert(API_CONFIG.statusElements, 'Should have status elements');
                assert(API_CONFIG.cache, 'Should have cache configuration');
            });

            runTest('isCacheValid returns false for no cache', () => {
                clearCache();
                assert(!isCacheValid(), 'Should return false when no cache exists');
            });

            runTest('setCache and getCachedData work correctly', () => {
                const testData = { accounts: 'test', transactions: 'test' };
                setCache(testData.accounts, testData.transactions);
                const cached = getCachedData();
                assert(cached.accounts === 'test', 'Should store and retrieve accounts data');
                assert(cached.transactions === 'test', 'Should store and retrieve transactions data');
            });

            displayResults();
        }

        // Test UI Functions
        function runUiTests() {
            testResults = { total: 0, passed: 0, failed: 0, tests: [] };
            
            runTest('DOM_CACHE exists and has required methods', () => {
                assert(DOM_CACHE, 'Should have DOM_CACHE object');
                assert(typeof DOM_CACHE.getElement === 'function', 'Should have getElement method');
                assert(typeof DOM_CACHE.clearCache === 'function', 'Should have clearCache method');
            });

            runTest('newTextNode creates elements correctly', () => {
                // Create a test container
                const testDiv = document.createElement('div');
                testDiv.id = 'test-container';
                document.body.appendChild(testDiv);
                
                // Mock the getElementById to return our test div
                const originalGetElement = DOM_CACHE.getElement;
                DOM_CACHE.getElement = (id) => id === 'test-container' ? testDiv : null;
                
                newTextNode('Test Message', 'p', 'test-container');
                
                assert(testDiv.children.length > 0, 'Should add element to container');
                assert(testDiv.textContent.includes('Test Message'), 'Should add correct text content');
                
                // Cleanup
                document.body.removeChild(testDiv);
                DOM_CACHE.getElement = originalGetElement;
            });

            displayResults();
        }

        // Run all tests
        function runAllTests() {
            testResults = { total: 0, passed: 0, failed: 0, tests: [] };
            
            runUtilsTests();
            runDataTests();
            runApiTests();
            runUiTests();
            
            displayResults();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Test suite loaded and ready');
        });
    </script>
</body>
</html>
